<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルGPIO信号通信システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white py-3 mb-4">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="h3 mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>
                            シンプルGPIO信号通信システム
                        </h1>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="simulationMode"
                                   {% if status.simulation_mode %}checked{% endif %} disabled>
                            <label class="form-check-label" for="simulationMode">
                                シミュレーションモード
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- ステータスパネル -->
            <section class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                システムステータス
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-play-circle me-2 text-success"></i>
                                        <span>通信状態: </span>
                                        <span id="commStatus" class="badge bg-secondary ms-2">停止中</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-toggle-on me-2 text-primary"></i>
                                        <span>スイッチ状態: </span>
                                        <span id="switchStatus" class="badge bg-secondary ms-2">未確認</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock me-2 text-info"></i>
                                        <span>最終更新: </span>
                                        <span id="lastUpdate" class="ms-2">---</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 制御パネル -->
            <section class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-gamepad me-2"></i>
                                制御パネル
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button id="startComm" class="btn btn-success me-2">
                                    <i class="fas fa-play me-1"></i>
                                    通信開始
                                </button>
                                <button id="stopComm" class="btn btn-danger me-2" disabled>
                                    <i class="fas fa-stop me-1"></i>
                                    通信停止
                                </button>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>使い方:</strong><br>
                                - タクトスイッチ (GPIO23) を押すと送信ピン (GPIO17) がHIGHになります<br>
                                - 受信ピン (GPIO18) の状態変化がリアルタイムで表示されます<br>
                                - 2つのRaspberry Pi間でGPIO17↔GPIO18とGNDを接続してください
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 受信信号表示 -->
            <section class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-wave-square me-2"></i>
                                受信信号履歴
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="signalList" class="signal-container">
                                <p class="text-muted">受信信号がここに表示されます</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-light py-3 mt-5">
            <div class="container text-center">
                <p class="text-muted mb-0">
                    <i class="fas fa-code me-1"></i>
                    シンプルGPIO信号通信システム
                </p>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // アプリケーション状態
        const app = {
            communicationActive: false,
            updateInterval: null
        };

        // DOM要素
        const elements = {
            startComm: document.getElementById('startComm'),
            stopComm: document.getElementById('stopComm'),
            commStatus: document.getElementById('commStatus'),
            switchStatus: document.getElementById('switchStatus'),
            lastUpdate: document.getElementById('lastUpdate'),
            signalList: document.getElementById('signalList')
        };

        // イベントリスナー設定
        function setupEventListeners() {
            elements.startComm.addEventListener('click', startCommunication);
            elements.stopComm.addEventListener('click', stopCommunication);
        }

        // API呼び出し関数
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'APIエラー');
                }

                return await response.json();
            } catch (error) {
                console.error('APIエラー:', error);
                alert(`エラー: ${error.message}`);
                return null;
            }
        }

        // 通信開始
        async function startCommunication() {
            const result = await apiCall('/api/start', { method: 'POST' });
            if (result && result.success) {
                app.communicationActive = true;
                updateUI();
            }
        }

        // 通信停止
        async function stopCommunication() {
            const result = await apiCall('/api/stop', { method: 'POST' });
            if (result && result.success) {
                app.communicationActive = false;
                updateUI();
            }
        }

        // 信号リスト更新
        function updateSignalList(signals) {
            if (!signals || signals.length === 0) {
                elements.signalList.innerHTML = '<p class="text-muted">受信信号がここに表示されます</p>';
                return;
            }

            let html = '';
            let currentMorse = '';
            let lastTimestamp = '';

            signals.forEach(signal => {
                // モールス符号がある場合
                if (signal.morse) {
                    currentMorse = signal.morse;
                }

                const badgeClass = (signal.signal === 'HIGH' || signal.signal === '・') ? 'bg-success' : 
                                 (signal.signal === 'LOW' || signal.signal === '－') ? 'bg-warning' : 'bg-secondary';

                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <span><strong>${signal.timestamp}</strong></span>
                        <span class="badge ${badgeClass}">${signal.signal}</span>
                        ${currentMorse ? `<span class="ms-2 text-primary"><strong>${currentMorse}</strong></span>` : ''}
                    </div>
                `;
            });

            elements.signalList.innerHTML = html;
        }

        // UI更新
        function updateUI() {
            elements.startComm.disabled = app.communicationActive;
            elements.stopComm.disabled = !app.communicationActive;
            elements.commStatus.textContent = app.communicationActive ? '実行中' : '停止中';
            elements.commStatus.className = app.communicationActive ? 'badge bg-success' : 'badge bg-secondary';
        }

        // ステータス更新
        async function updateStatus() {
            const status = await apiCall('/api/status');
            if (status) {
                app.communicationActive = status.running;
                elements.switchStatus.textContent = status.switch_state;
                elements.switchStatus.className = status.switch_state === 'PRESSED' ? 'badge bg-primary' : 'badge bg-secondary';
                elements.lastUpdate.textContent = new Date().toLocaleTimeString();
                updateUI();
            }
        }

        // 信号更新
        async function updateSignals() {
            const data = await apiCall('/api/signals');
            if (data) {
                updateSignalList(data.signals);
            }
        }

        // 初期化
        function init() {
            setupEventListeners();
            updateUI();

            // 定期更新
            app.updateInterval = setInterval(() => {
                updateStatus();
                updateSignals();
            }, 500);  // 0.5秒ごとに更新
        }

        // ページ読み込み完了時に初期化
        document.addEventListener('DOMContentLoaded', init);

        // ページアンロード時にクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (app.updateInterval) {
                clearInterval(app.updateInterval);
            }
        });
    </script>
</body>
</html>
