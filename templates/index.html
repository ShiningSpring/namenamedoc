<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モールス信号通信システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white py-3 mb-4">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="h3 mb-0">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            モールス信号通信システム
                        </h1>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="simulationMode" 
                                   {% if status.simulation_mode %}checked{% endif %}>
                            <label class="form-check-label" for="simulationMode">
                                シミュレーションモード
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- ステータスパネル -->
            <section class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                システムステータス
                            </h5>
                            <div>
                                <span id="connectionStatus" class="badge bg-secondary">
                                    <i class="fas fa-circle me-1"></i>
                                    未接続
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-exchange-alt me-2 text-primary"></i>
                                        <span>通信状態: </span>
                                        <span id="commStatus" class="badge bg-secondary ms-2">停止中</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-paper-plane me-2 text-success"></i>
                                        <span>送信状態: </span>
                                        <span id="transmitStatus" class="badge bg-secondary ms-2">待機中</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                                        <span>LED: </span>
                                        <span id="ledStatus" class="badge bg-secondary ms-2">OFF</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-volume-up me-2 text-info"></i>
                                        <span>サウンド: </span>
                                        <span id="soundStatus" class="badge bg-secondary ms-2">OFF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 制御パネル -->
            <section class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-gamepad me-2"></i>
                                制御パネル
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- 通信制御 -->
                            <div class="mb-3">
                                <button id="startComm" class="btn btn-success me-2">
                                    <i class="fas fa-play me-1"></i>
                                    通信開始
                                </button>
                                <button id="stopComm" class="btn btn-danger me-2" disabled>
                                    <i class="fas fa-stop me-1"></i>
                                    通信停止
                                </button>
                                <button id="clearMessages" class="btn btn-warning">
                                    <i class="fas fa-trash me-1"></i>
                                    メッセージクリア
                                </button>
                            </div>

                            <!-- メッセージ送信 -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="form-control" 
                                           placeholder="メッセージを入力..." maxlength="50">
                                    <button id="sendMessage" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>
                                        送信
                                    </button>
                                </div>
                            </div>

                            <!-- テンプレートメッセージ -->
                            <div class="mb-3">
                                <label class="form-label">テンプレートメッセージ:</label>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for msg in template_messages %}
                                    <button class="btn btn-outline-primary template-btn" data-message="{{ msg }}">
                                        {{ msg }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                設定
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- LED設定 -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ledEnabled" checked>
                                    <label class="form-check-label" for="ledEnabled">
                                        LEDフィードバック
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label">LED輝度:</label>
                                    <input type="range" id="ledBrightness" class="form-range" 
                                           min="0" max="100" value="80">
                                    <small class="text-muted">輝度: <span id="brightnessValue">80</span>%</small>
                                </div>
                            </div>

                            <!-- サウンド設定 -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="soundEnabled" checked>
                                    <label class="form-check-label" for="soundEnabled">
                                        サウンドフィードバック
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label">ブザー周波数:</label>
                                    <input type="range" id="buzzerFrequency" class="form-range" 
                                           min="200" max="2000" value="1000" step="100">
                                    <small class="text-muted">周波数: <span id="frequencyValue">1000</span>Hz</small>
                                </div>
                            </div>

                            <!-- 通信設定 -->
                            <div class="mb-3">
                                <label class="form-label">相手Pi IPアドレス:</label>
                                <input type="text" id="remotePiIp" class="form-control" 
                                       placeholder="192.168.1.100" value="{{ status.remote_pi_ip }}">
                            </div>

                            <!-- テストボタン -->
                            <div class="d-grid gap-2">
                                <button id="testLed" class="btn btn-outline-warning">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    LEDテスト
                                </button>
                                <button id="testBuzzer" class="btn btn-outline-info">
                                    <i class="fas fa-volume-up me-1"></i>
                                    ブザーテスト
                                </button>
                                <button id="testSwitch" class="btn btn-outline-secondary">
                                    <i class="fas fa-hand-pointer me-1"></i>
                                    スイッチテスト
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- メッセージ表示 -->
            <section class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-paper-plane me-2"></i>
                                送信メッセージ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="sentMessages" class="message-container">
                                <p class="text-muted">送信メッセージがここに表示されます</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-inbox me-2"></i>
                                受信メッセージ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="receivedMessages" class="message-container">
                                <p class="text-muted">受信メッセージがここに表示されます</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-light py-3 mt-5">
            <div class="container text-center">
                <p class="text-muted mb-0">
                    <i class="fas fa-code me-1"></i>
                    Raspberry Pi モールス信号通信システム
                </p>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // アプリケーション状態
        const app = {
            communicationActive: false,
            isTransmitting: false,
            updateInterval: null
        };

        // DOM要素
        const elements = {
            startComm: document.getElementById('startComm'),
            stopComm: document.getElementById('stopComm'),
            clearMessages: document.getElementById('clearMessages'),
            sendMessage: document.getElementById('sendMessage'),
            messageInput: document.getElementById('messageInput'),
            sentMessages: document.getElementById('sentMessages'),
            receivedMessages: document.getElementById('receivedMessages'),
            commStatus: document.getElementById('commStatus'),
            transmitStatus: document.getElementById('transmitStatus'),
            ledStatus: document.getElementById('ledStatus'),
            soundStatus: document.getElementById('soundStatus'),
            connectionStatus: document.getElementById('connectionStatus'),
            ledEnabled: document.getElementById('ledEnabled'),
            soundEnabled: document.getElementById('soundEnabled'),
            ledBrightness: document.getElementById('ledBrightness'),
            buzzerFrequency: document.getElementById('buzzerFrequency'),
            brightnessValue: document.getElementById('brightnessValue'),
            frequencyValue: document.getElementById('frequencyValue'),
            remotePiIp: document.getElementById('remotePiIp'),
            testLed: document.getElementById('testLed'),
            testBuzzer: document.getElementById('testBuzzer'),
            testSwitch: document.getElementById('testSwitch')
        };

        // イベントリスナー設定
        function setupEventListeners() {
            // 通信制御
            elements.startComm.addEventListener('click', startCommunication);
            elements.stopComm.addEventListener('click', stopCommunication);
            elements.clearMessages.addEventListener('click', clearAllMessages);
            elements.sendMessage.addEventListener('click', sendMessage);
            
            // Enterキーで送信
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // テンプレートボタン
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.messageInput.value = btn.dataset.message;
                    sendMessage();
                });
            });

            // 設定変更
            elements.ledEnabled.addEventListener('change', updateSettings);
            elements.soundEnabled.addEventListener('change', updateSettings);
            elements.ledBrightness.addEventListener('input', (e) => {
                elements.brightnessValue.textContent = e.target.value;
                updateSettings();
            });
            elements.buzzerFrequency.addEventListener('input', (e) => {
                elements.frequencyValue.textContent = e.target.value;
                updateSettings();
            });
            elements.remotePiIp.addEventListener('change', updateSettings);

            // テストボタン
            elements.testLed.addEventListener('click', testLed);
            elements.testBuzzer.addEventListener('click', testBuzzer);
            elements.testSwitch.addEventListener('click', testSwitch);
        }

        // API呼び出し関数
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'APIエラー');
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIエラー:', error);
                alert(`エラー: ${error.message}`);
                return null;
            }
        }

        // 通信開始
        async function startCommunication() {
            const result = await apiCall('/api/communication/start', { method: 'POST' });
            if (result) {
                app.communicationActive = true;
                updateUI();
                addMessage('sent', '通信を開始しました');
            }
        }

        // 通信停止
        async function stopCommunication() {
            const result = await apiCall('/api/communication/stop', { method: 'POST' });
            if (result) {
                app.communicationActive = false;
                updateUI();
                addMessage('sent', '通信を停止しました');
            }
        }

        // メッセージ送信
        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message) {
                alert('メッセージを入力してください');
                return;
            }

            const result = await apiCall('/api/send', {
                method: 'POST',
                body: JSON.stringify({ message })
            });

            if (result) {
                addMessage('sent', message);
                elements.messageInput.value = '';
                app.isTransmitting = true;
                updateUI();
                
                // 送信完了を待機
                setTimeout(() => {
                    app.isTransmitting = false;
                    updateUI();
                }, 2000);
            }
        }

        // メッセージクリア
        async function clearAllMessages() {
            const result = await apiCall('/api/clear', { method: 'POST' });
            if (result) {
                elements.sentMessages.innerHTML = '<p class="text-muted">送信メッセージがここに表示されます</p>';
                elements.receivedMessages.innerHTML = '<p class="text-muted">受信メッセージがここに表示されます</p>';
            }
        }

        // 設定更新
        async function updateSettings() {
            const settings = {
                led_enabled: elements.ledEnabled.checked,
                sound_enabled: elements.soundEnabled.checked,
                led_brightness: elements.ledBrightness.value / 100,
                buzzer_frequency: parseInt(elements.buzzerFrequency.value),
                remote_pi_ip: elements.remotePiIp.value
            };

            await apiCall('/api/settings', {
                method: 'POST',
                body: JSON.stringify(settings)
            });
        }

        // テスト関数
        async function testLed() {
            await apiCall('/api/test/led', { method: 'POST' });
        }

        async function testBuzzer() {
            await apiCall('/api/test/buzzer', { method: 'POST' });
        }

        async function testSwitch() {
            await apiCall('/api/test/switch', { method: 'POST' });
        }

        // メッセージ追加
        function addMessage(type, message) {
            const container = type === 'sent' ? elements.sentMessages : elements.receivedMessages;
            const timestamp = new Date().toLocaleTimeString();
            
            // 最初のメッセージの場合はプレースホルダーを削除
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'message-item mb-2 p-2 border rounded';
            messageElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <span class="message-text">${message}</span>
                    <small class="text-muted timestamp">${timestamp}</small>
                </div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // UI更新
        function updateUI() {
            // ボタン状態
            elements.startComm.disabled = app.communicationActive;
            elements.stopComm.disabled = !app.communicationActive;
            elements.sendMessage.disabled = !app.communicationActive || app.isTransmitting;
            elements.messageInput.disabled = !app.communicationActive;

            // ステータス更新
            elements.commStatus.textContent = app.communicationActive ? '通信中' : '停止中';
            elements.commStatus.className = app.communicationActive ? 'badge bg-success' : 'badge bg-secondary';
            
            elements.transmitStatus.textContent = app.isTransmitting ? '送信中' : '待機中';
            elements.transmitStatus.className = app.isTransmitting ? 'badge bg-warning' : 'badge bg-secondary';
        }

        // ステータス更新
        async function updateStatus() {
            const status = await apiCall('/api/status');
            if (status) {
                app.communicationActive = status.communication_active;
                app.isTransmitting = status.is_transmitting;
                
                // LED/サウンドステータス
                elements.ledStatus.textContent = status.feedback.led_enabled ? 'ON' : 'OFF';
                elements.ledStatus.className = status.feedback.led_enabled ? 'badge bg-warning' : 'badge bg-secondary';
                
                elements.soundStatus.textContent = status.feedback.sound_enabled ? 'ON' : 'OFF';
                elements.soundStatus.className = status.feedback.sound_enabled ? 'badge bg-info' : 'badge bg-secondary';
                
                // 接続ステータス
                elements.connectionStatus.textContent = app.communicationActive ? '接続済み' : '未接続';
                elements.connectionStatus.className = app.communicationActive ? 'badge bg-success' : 'badge bg-secondary';
                
                updateUI();
            }
        }

        // 受信メッセージ更新
        async function updateReceivedMessages() {
            const data = await apiCall('/api/receive');
            if (data && data.message) {
                const currentContent = elements.receivedMessages.textContent;
                if (!currentContent.includes(data.message.trim())) {
                    addMessage('received', data.message);
                }
            }
        }

        // 初期化
        function init() {
            setupEventListeners();
            updateUI();
            
            // 定期更新
            app.updateInterval = setInterval(() => {
                updateStatus();
                updateReceivedMessages();
            }, 1000);
        }

        // ページ読み込み完了時に初期化
        document.addEventListener('DOMContentLoaded', init);

        // ページアンロード時にクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (app.updateInterval) {
                clearInterval(app.updateInterval);
            }
        });
    </script>
</body>
</html>
